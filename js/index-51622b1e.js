import{ei as w,aN as m,ej as N,h as u,l as h,k as d,m as k,bM as f}from"./index-2ccee8cf.js";import{l as E,b as g}from"./index-08a147b7.js";import{E as s}from"./types-a9f3cfbf.js";class T{constructor(){this.initNotice()}initNotice(){return new Promise((o,e)=>{if(!("Notification"in window))e(new Error("浏览器不支持发送通知"));else if(Notification.permission!=="denied")Notification.requestPermission().then(i=>i==="granted"?o(!0):e(new Error("已拒绝通知")));else{if(Notification.permission==="denied")return e(new Error("已拒绝通知"));e(!0)}})}notice(o,e,i={}){return new Promise(t=>{this.initNotice().then(n=>{if(n&&!document.hasFocus()){const r=new Notification(o,{body:e,...i});t(r)}})})}}const a={get warning(){return window.notification.warning},get warn(){return window.notification.warning},get success(){return window.notification.success},get error(){return window.notification.error},get info(){return window.notification.info}};class p{get socket(){return this._socket}#e=w.title;#t=new T;isInit=!1;initIO(){if(this.isInit)return;this.destory();const o=m();o&&(this._socket=E(`${N}/admin`,{timeout:1e4,transports:["websocket"],forceNew:!0,query:{token:o.replace(/^bearer\s/,"")}}),this.socket.on("message",e=>{if(typeof e!="string")return this.handleEvent(e.type,e.data,e.code);const{data:i,type:t,code:n}=JSON.parse(e);this.handleEvent(t,i,n)}),this.socket.on("connect_error",()=>{}),this.socket.io.on("error",()=>{}),this.socket.io.on("reconnect",()=>{}),this.socket.io.on("reconnect_attempt",()=>{}),this.socket.io.on("reconnect_failed",()=>{}),this.socket.on("disconnect",()=>{let i=setInterval(()=>{this.socket.connected===!1?this.socket.io.connect():i=clearInterval(i)},2e3)}),this.isInit=!0)}handleEvent(o,e,i){switch(o){case s.GATEWAY_CONNECT:break;case s.GATEWAY_DISCONNECT:{a.warning(e);break}case s.AUTH_FAILED:{console.log("等待登录中..."),this.socket.close();break}case s.COMMENT_CREATE:{const t=`${e.author}: ${e.text}`,n=()=>{f.push({name:"comment"}),r.destroy()},r=a.success({title:"新的评论",content:t,action(){return u(k,{justify:"end"},{default:()=>[u(h,{onClick:n,type:"primary",round:!0,ghost:!0},{default:()=>[d("查看")]})]})}});this.#t.notice(`${this.#e} 收到新的评论`,t).then(c=>{c&&(c.onclick=()=>{document.hasFocus()?n():window.open(f.resolve({name:"comment"}).href)})});break}case s.ADMIN_NOTIFICATION:{const{type:t,message:n}=e;a[t]({content:n});break}case s.CONTENT_REFRESH:{a.warning({content:"数据库有变动，将在 1 秒后重载页面"}),setTimeout(()=>{location.reload()},1e3);break}case s.LINK_APPLY:{const t=e.name,n=()=>{f.push({name:"friends",query:{state:1}}),r.destroy()},r=a.success({title:"新的友链申请",content:t,action(){return u(k,{justify:"end"},{default:()=>[u(h,{onClick:n,type:"primary",round:!0,ghost:!0},{default:()=>[d("查看")]})]})}});this.#t.notice(`${this.#e} 收到新的友链申请`,t).then(c=>{c&&(c.onclick=()=>{document.hasFocus()?n():window.open("/")})});break}}g.emit(o,e,i)}destory(){this.socket&&(this.socket.disconnect(),this.socket.off("message"),this.socket.offAny(),this._socket=null,this.isInit=!1)}}const I=new p;window.socket=I;export{I as socket};
